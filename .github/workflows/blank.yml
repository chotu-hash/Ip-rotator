name: Linux VPS

on:
  workflow_dispatch:

jobs:
  ubuntu-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Setup SSH User
        run: |
          PASSWORD=$(openssl rand -base64 16)
          echo "PASSWORD=$PASSWORD" >> $GITHUB_ENV

          sudo useradd -m -s /bin/bash vps
          echo "vps:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo vps

          echo "✅ User 'vps' created with a random password."

      - name: Install and Run Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-ubuntu-runner
          echo "✅ Tailscale connected."

      - name: Install microsocks
        run: |
          sudo apt update -y
          sudo apt install -y git build-essential curl wget
          git clone https://github.com/rofl0r/microsocks.git
          cd microsocks && make
          sudo cp microsocks /usr/local/bin/
          nohup microsocks -p 1080 -u proxyuser -P proxypass &

      - name: Install Cloudflare Tunnel
        run: |
          curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared

      - name: Start Cloudflare Tunnel
        env:
          CF_TUNNEL_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
        run: |
          nohup cloudflared tunnel run --token "$CF_TUNNEL_TOKEN" > tunnel.log 2>&1 &
          echo "✅ Tunnel started"
          
      - name: Display Connection Details & Keep Alive
        run: |
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "================================================="
          echo "    SSH Connection Details"
          echo "================================================="
          echo "IP Address: $TS_IP"
          echo "Username:   vps"
          echo "Password:   ${{ env.PASSWORD }}"
          echo ""
          echo "To connect: ssh vps@$TS_IP"
          echo "================================================="
          for i in {1..60}; do
            echo "[$(date)] Session active..."
            sleep 300
          done
