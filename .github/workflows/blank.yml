name: SOCKS5 Proxy via Cloudflare

on:
  workflow_dispatch:

jobs:
  proxy:
    runs-on: ubuntu-latest
    steps:
      - name: Install microsocks
        run: |
          sudo apt update -y
          sudo apt install -y git build-essential
          git clone https://github.com/rofl0r/microsocks.git
          cd microsocks && make
          sudo cp microsocks /usr/local/bin/

      - name: Start SOCKS5 proxy (bind to all interfaces)
        run: |
          nohup microsocks -i 0.0.0.0 -p 1080 -u proxyuser -P proxypass > socks.log 2>&1 &
          sleep 5
          netstat -tlnp | grep 1080 || echo "SOCKS not listening"

      - name: Install Cloudflare Tunnel
        run: |
          curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared

      - name: Create tunnel configuration
        run: |
          cat > tunnel.yml << EOF
          tunnel: socks5-tunnel
          credentials-file: /root/.cloudflared/credentials.json
          ingress:
            - hostname: proxy.trendscoop.xyz
              service: tcp://localhost:1080
            - service: http_status:404
          EOF
          sudo mkdir -p /root/.cloudflared/
          echo "${{ secrets.CF_TUNNEL_CREDENTIALS }}" | sudo tee /root/.cloudflared/credentials.json > /dev/null

      - name: Start Cloudflare Tunnel
        run: |
          sudo nohup cloudflared tunnel --config tunnel.yml run socks5-tunnel > tunnel.log 2>&1 &
          sleep 10
          echo "Tunnel started"
          cat tunnel.log || echo "No tunnel log yet"

      - name: Keep alive
        run: |
          echo "üåê SOCKS5 Proxy active via Cloudflare Tunnel"
          echo "Use: curl --socks5 proxy.trendscoop.xyz:1080 -U proxyuser:proxypass https://ifconfig.me"
          sleep 24h
