name: HTTP/HTTPS Proxy via Cloudflare

on:
  workflow_dispatch:

jobs:
  proxy:
    runs-on: ubuntu-latest
    steps:
      - name: Install Squid Proxy
        run: |
          sudo apt update -y
          sudo apt install -y squid jq apache2-utils

      - name: Configure Squid
        run: |
          # Stop any running Squid first
          sudo systemctl stop squid 2>/dev/null || true
          sudo pkill squid 2>/dev/null || true
          sleep 2
          
          # Create password file using htpasswd
          sudo htpasswd -b -c /etc/squid/passwords proxyuser proxypass
          sudo chown proxy:proxy /etc/squid/passwords

          # Modern Squid configuration
          sudo tee /etc/squid/squid.conf > /dev/null << 'EOF'
          http_port 3128
          
          # Basic settings
          cache deny all
          forwarded_for delete
          via off
          
          # Authentication
          auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwords
          auth_param basic realm "Squid Proxy"
          auth_param basic credentialsttl 2 hours
          acl authenticated proxy_auth REQUIRED
          
          # ACLs for security
          acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
          acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
          acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
          acl localnet src 169.254.0.0/16         # RFC 3927 link-local (direct plug-in)
          acl localnet src 172.16.0.0/12          # RFC 1918 local private network (LAN)
          acl localnet src 192.168.0.0/16         # RFC 1918 local private network (LAN)
          acl localnet src fc00::/7                # RFC 4193 local private network range
          acl localnet src fe80::/10               # RFC 4291 link-local (direct plug-in)
          
          acl SSL_ports port 443
          acl Safe_ports port 80          # http
          acl Safe_ports port 21          # ftp
          acl Safe_ports port 443         # https
          acl Safe_ports port 70          # gopher
          acl Safe_ports port 210         # wais
          acl Safe_ports port 1025-65535  # unregistered ports
          acl Safe_ports port 280         # http-mgmt
          acl Safe_ports port 488         # gss-http
          acl Safe_ports port 591         # filemaker
          acl Safe_ports port 777         # multiling http
          acl CONNECT method CONNECT
          
          # Default access rules
          http_access deny !Safe_ports
          http_access deny CONNECT !SSL_ports
          http_access allow localhost
          http_access allow authenticated
          http_access deny all
          
          # Leave via off for anonymity but handle the warning
          via off
          EOF

          # Create cache directories
          sudo mkdir -p /var/cache/squid
          sudo mkdir -p /var/log/squid
          sudo chown -R proxy:proxy /var/cache/squid /var/log/squid

          # Initialize cache (non-interactive)
          sudo squid -z 2>/dev/null || true
          
          # Start Squid
          sudo systemctl start squid
          sudo systemctl enable squid
          
          sleep 5
          echo "=== Squid Status ==="
          sudo systemctl status squid --no-pager | head -10
          echo "=== Network Ports ==="
          sudo netstat -tlnp | grep 3128 || echo "Squid port check"

      - name: Install cloudflared
        run: |
          curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared

      - name: Setup tunnel configuration
        env:
          TUNNEL_CREDS: ${{ secrets.CF_TUNNEL_CREDENTIALS }}
        run: |
          mkdir -p ~/.cloudflared/
          echo "$TUNNEL_CREDS" > ~/.cloudflared/creds.json
          
          # Create config
          cat > ~/.cloudflared/config.yml << EOF
          tunnel: d09d85ca-86ef-45e3-b340-9f00d90b6244
          credentials-file: /home/runner/.cloudflared/creds.json
          ingress:
            - hostname: proxy.trendscoop.xyz
              service: http://localhost:3128
            - service: http_status:404
          EOF
          
          echo "‚úÖ Tunnel configuration created"

      - name: Start Cloudflare Tunnel
        run: |
          # Stop any existing cloudflared
          pkill cloudflared 2>/dev/null || true
          sleep 2
          
          # Start tunnel
          nohup cloudflared tunnel run > tunnel.log 2>&1 &
          sleep 25
          
          echo "=== Tunnel Status ==="
          cloudflared tunnel list 2>&1 | head -10 || echo "Tunnel list completed"
          echo "=== Recent Logs ==="
          tail -10 tunnel.log

      - name: Test proxy locally
        run: |
          echo "=== Testing HTTP Proxy Locally ==="
          timeout 10 curl -s --proxy http://proxyuser:proxypass@127.0.0.1:3128 http://httpbin.org/ip || echo "HTTP test completed"
          
          echo "=== Testing HTTPS Proxy Locally ==="
          timeout 10 curl -s --proxy http://proxyuser:proxypass@127.0.0.1:3128 https://httpbin.org/ip || echo "HTTPS test completed"

      - name: Final verification
        run: |
          echo "=== Service Status ==="
          sudo systemctl is-active squid && echo "‚úÖ Squid: RUNNING" || echo "‚ùå Squid: STOPPED"
          pgrep cloudflared >/dev/null && echo "‚úÖ Cloudflare Tunnel: RUNNING" || echo "‚ùå Cloudflare Tunnel: STOPPED"
          
          echo "=== Network Verification ==="
          sudo netstat -tlnp | grep 3128 && echo "‚úÖ Squid listening on 3128" || echo "‚ùå Squid not listening"

      - name: Keep alive with usage instructions
        run: |
          echo "üåê HTTP/HTTPS PROXY READY"
          echo "=========================================="
          echo ""
          echo "üöÄ USAGE COMMANDS:"
          echo ""
          echo "For HTTP websites:"
          echo "curl --proxy http://proxyuser:proxypass@proxy.trendscoop.xyz:80 http://ifconfig.me"
          echo ""
          echo "For HTTPS websites:"
          echo "curl --proxy http://proxyuser:proxypass@proxy.trendscoop.xyz:443 https://ifconfig.me"
          echo ""
          echo "Alternative syntax:"
          echo "curl -x http://proxyuser:proxypass@proxy.trendscoop.xyz:443 https://ifconfig.me"
          echo ""
          echo "=========================================="
          echo "üîß CONFIGURATION:"
          echo "Proxy Server: proxy.trendscoop.xyz"
          echo "Port: 80 (HTTP) or 443 (HTTPS)"
          echo "Username: proxyuser"
          echo "Password: proxypass"
          echo ""
          echo "üìä Monitoring..."
          COUNTER=0
          while true; do
            echo "$(date) - Proxy active for $((COUNTER * 60)) seconds"
            # Quick service check
            sudo systemctl is-active squid >/dev/null && echo "‚úÖ Squid OK" || echo "‚ùå Squid DOWN"
            pgrep cloudflared >/dev/null && echo "‚úÖ Tunnel OK" || echo "‚ùå Tunnel DOWN"
            echo "---"
            COUNTER=$((COUNTER + 1))
            sleep 60
          done
