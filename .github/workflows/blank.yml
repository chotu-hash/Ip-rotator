name: SOCKS5 Proxy via Cloudflare

on:
  workflow_dispatch:

jobs:
  proxy:
    runs-on: ubuntu-latest
    steps:
      - name: Install microsocks
        run: |
          sudo apt update -y
          sudo apt install -y git build-essential curl wget
          git clone https://github.com/rofl0r/microsocks.git
          cd microsocks && make
          sudo cp microsocks /usr/local/bin/
          nohup microsocks -p 1080 -u proxyuser -P proxypass &

      - name: Install Cloudflare Tunnel
        run: |
          curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared

      - name: Start Cloudflare Tunnel
        env:
          CF_TUNNEL_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
        run: |
          nohup cloudflared tunnel run --token "$CF_TUNNEL_TOKEN" > tunnel.log 2>&1 &
          echo "✅ Tunnel started"

      - name: Keep alive (cancel manually when done)
        run: |
          echo "🌐 Proxy active. Keep this job running to use it."
          echo "To stop, cancel workflow manually."
          sleep 24h
